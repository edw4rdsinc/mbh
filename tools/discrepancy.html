<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" type="image/png" href="../Images/mbh-icon.png">
    <title>Discrepancy Analyzer | My Benefits Help</title>

    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Work+Sans:wght@600;700&display=swap" rel="stylesheet">

    <!-- Supabase SDK -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <style>
        :root {
            --mbh-bg: #ffffff;
            --mbh-fg: #0f172a;
            --mbh-muted: #475569;
            --mbh-primary: #00529b;
            --mbh-accent: #0891b2;
            --mbh-action: #E87A5D;
            --mbh-bg-alt: #F5F5F5;
            --mbh-border: #e2e8f0;
            --mbh-success: #22c55e;
            --mbh-error: #ef4444;
            --mbh-warning: #f59e0b;
        }

        *, *::before, *::after {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--mbh-bg);
            color: var(--mbh-fg);
            min-height: 100vh;
        }

        .header {
            background: var(--mbh-bg);
            border-bottom: 1px solid var(--mbh-border);
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 50;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .back-link {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            color: var(--mbh-muted);
            text-decoration: none;
            font-weight: 500;
            font-size: 0.9rem;
        }

        .back-link:hover {
            color: var(--mbh-primary);
        }

        .header-title {
            font-family: 'Work Sans', sans-serif;
            font-size: 1.25rem;
            color: var(--mbh-fg);
            padding-left: 1rem;
            border-left: 1px solid var(--mbh-border);
        }

        .user-email {
            font-size: 0.875rem;
            color: var(--mbh-muted);
        }

        .main {
            max-width: 900px;
            margin: 0 auto;
            padding: 2rem;
        }

        .card {
            background: var(--mbh-bg);
            border: 1px solid var(--mbh-border);
            border-radius: 1rem;
            padding: 2rem;
            margin-bottom: 1.5rem;
        }

        .card h2 {
            font-family: 'Work Sans', sans-serif;
            font-size: 1.35rem;
            margin-bottom: 0.5rem;
        }

        .card .description {
            color: var(--mbh-muted);
            font-size: 0.95rem;
            margin-bottom: 1.5rem;
        }

        /* Phase indicator */
        .phase-indicator {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1.5rem;
        }

        .phase-step {
            flex: 1;
            padding: 0.75rem;
            background: var(--mbh-bg-alt);
            border-radius: 0.5rem;
            text-align: center;
            font-size: 0.85rem;
            color: var(--mbh-muted);
            position: relative;
        }

        .phase-step.active {
            background: var(--mbh-primary);
            color: white;
        }

        .phase-step.completed {
            background: var(--mbh-success);
            color: white;
        }

        .phase-step .step-num {
            font-weight: 700;
            display: block;
        }

        /* Upload */
        .input-row {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 1.5rem;
            margin-bottom: 1.5rem;
        }

        .input-group label {
            display: block;
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--mbh-muted);
            margin-bottom: 0.5rem;
        }

        .input-group input {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid var(--mbh-border);
            border-radius: 0.5rem;
            font-size: 0.95rem;
        }

        .input-group input:focus {
            outline: none;
            border-color: var(--mbh-primary);
        }

        .upload-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1.5rem;
        }

        @media (max-width: 700px) {
            .upload-grid { grid-template-columns: 1fr; }
        }

        .upload-box {
            border: 2px dashed var(--mbh-border);
            border-radius: 0.75rem;
            padding: 2rem 1.5rem;
            text-align: center;
            background: var(--mbh-bg-alt);
            cursor: pointer;
            transition: all 0.2s;
        }

        .upload-box:hover { border-color: var(--mbh-primary); }
        .upload-box.has-file {
            border-style: solid;
            border-color: var(--mbh-success);
            background: #f0fdf4;
        }

        .upload-box h3 {
            font-size: 1rem;
            margin-bottom: 0.5rem;
            color: var(--mbh-primary);
        }

        .upload-box p { font-size: 0.85rem; color: var(--mbh-muted); }
        .upload-box .file-name { font-weight: 600; color: var(--mbh-success); margin-top: 0.5rem; }
        .upload-box input[type="file"] { display: none; }

        /* Mapping */
        .mapping-section {
            display: none;
            margin-top: 1.5rem;
            padding-top: 1.5rem;
            border-top: 1px solid var(--mbh-border);
        }

        .mapping-section.visible { display: block; }
        .mapping-section h3 { font-size: 1.1rem; margin-bottom: 1rem; color: var(--mbh-primary); }

        .mapping-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }

        .mapping-group {
            background: var(--mbh-bg-alt);
            padding: 1rem;
            border-radius: 0.5rem;
        }

        .mapping-group h4 { font-size: 0.9rem; margin-bottom: 0.75rem; }

        .mapping-row {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 0.5rem;
        }

        .mapping-row label { font-size: 0.8rem; color: var(--mbh-muted); width: 100px; }
        .mapping-row select {
            flex: 1;
            padding: 0.4rem 0.5rem;
            border: 1px solid var(--mbh-border);
            border-radius: 0.25rem;
            font-size: 0.85rem;
        }

        /* Buttons */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            font-weight: 600;
            font-size: 0.95rem;
            cursor: pointer;
            border: none;
            transition: all 0.2s;
        }

        .btn-primary { background: var(--mbh-action); color: white; }
        .btn-primary:hover:not(:disabled) { background: #d66a4d; }
        .btn-primary:disabled { opacity: 0.5; cursor: not-allowed; }
        .btn-secondary { background: var(--mbh-bg); color: var(--mbh-fg); border: 1px solid var(--mbh-border); }
        .btn-success { background: var(--mbh-success); color: white; }
        .btn-success:hover { background: #16a34a; }

        .actions { margin-top: 1.5rem; display: flex; gap: 1rem; }

        /* Summary */
        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .summary-item {
            background: var(--mbh-bg-alt);
            padding: 1rem;
            border-radius: 0.5rem;
            text-align: center;
        }

        .summary-item .value { font-size: 1.5rem; font-weight: 700; color: var(--mbh-primary); }
        .summary-item .label { font-size: 0.75rem; color: var(--mbh-muted); margin-top: 0.25rem; }
        .summary-item.success .value { color: var(--mbh-success); }
        .summary-item.warning .value { color: var(--mbh-warning); }
        .summary-item.error .value { color: var(--mbh-error); }

        /* Review sections */
        .review-section { display: none; }
        .review-section.visible { display: block; }
        .review-section h3 { font-size: 1.1rem; margin-bottom: 0.5rem; }
        .review-section .description { font-size: 0.9rem; color: var(--mbh-muted); margin-bottom: 1rem; }

        .review-item {
            border: 1px solid var(--mbh-border);
            border-radius: 0.5rem;
            padding: 1rem;
            margin-bottom: 0.75rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 1rem;
        }

        .review-item.approved { border-color: var(--mbh-success); background: #f0fdf4; }
        .review-item.rejected { border-color: var(--mbh-error); background: #fef2f2; }

        .review-info { flex: 1; }
        .review-names { display: flex; align-items: center; gap: 0.5rem; font-weight: 600; margin-bottom: 0.25rem; }
        .review-names .arrow { color: var(--mbh-muted); }
        .review-details { font-size: 0.85rem; color: var(--mbh-muted); }
        .review-score { font-weight: 600; color: var(--mbh-warning); }

        .review-actions { display: flex; gap: 0.5rem; }
        .review-actions button {
            padding: 0.4rem 0.75rem;
            font-size: 0.8rem;
            border-radius: 0.25rem;
            cursor: pointer;
            border: 1px solid;
        }
        .review-actions .approve { background: var(--mbh-success); color: white; border-color: var(--mbh-success); }
        .review-actions .reject { background: var(--mbh-bg); color: var(--mbh-error); border-color: var(--mbh-error); }

        /* Premium review specific */
        .premium-details {
            font-size: 0.85rem;
            margin-top: 0.5rem;
            padding: 0.5rem;
            background: var(--mbh-bg-alt);
            border-radius: 0.25rem;
        }

        .premium-details .products { display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem; margin-top: 0.5rem; }
        .premium-details .products div { font-size: 0.8rem; }

        /* Bulk actions */
        .bulk-actions {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            padding: 0.75rem;
            background: var(--mbh-bg-alt);
            border-radius: 0.5rem;
        }

        .bulk-actions span { font-size: 0.9rem; color: var(--mbh-muted); }

        /* Status */
        .status-message {
            padding: 1rem;
            border-radius: 0.5rem;
            margin-bottom: 1rem;
            display: none;
        }

        .status-message.visible { display: block; }
        .status-message.loading { background: #eff6ff; color: var(--mbh-primary); }
        .status-message.success { background: #f0fdf4; color: #166534; }
        .status-message.error { background: #fef2f2; color: #dc2626; }

        /* Download */
        .download-section {
            display: none;
            text-align: center;
            padding: 2rem;
            background: #f0fdf4;
            border-radius: 0.5rem;
        }

        .download-section.visible { display: block; }
        .download-section h3 { color: var(--mbh-success); margin-bottom: 0.5rem; }
        .download-section p { color: var(--mbh-muted); margin-bottom: 1rem; }

        /* Hidden sections */
        .hidden { display: none !important; }
    </style>
</head>
<body>
    <header class="header">
        <div class="header-left">
            <a href="index.html" class="back-link">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M19 12H5M12 19l-7-7 7-7"/>
                </svg>
                Tools
            </a>
            <span class="header-title">Discrepancy Analyzer</span>
        </div>
        <span class="user-email" id="userEmail"></span>
    </header>

    <main class="main">
        <!-- Phase Indicator -->
        <div class="phase-indicator" id="phaseIndicator">
            <div class="phase-step active" id="phase1Step">
                <span class="step-num">1</span>
                Upload & Name Matching
            </div>
            <div class="phase-step" id="phase2Step">
                <span class="step-num">2</span>
                Download Report
            </div>
        </div>

        <!-- Status -->
        <div class="status-message" id="statusMessage"></div>

        <!-- Phase 1: Upload -->
        <div class="card" id="uploadCard">
            <h2>Upload Files</h2>
            <p class="description">Compare carrier data with payroll data to find discrepancies.</p>

            <div class="input-row">
                <div class="input-group">
                    <label for="groupName">Group Name</label>
                    <input type="text" id="groupName" placeholder="e.g. ABC Company" required>
                </div>
                <div class="input-group">
                    <label for="reportMonth">Report Month</label>
                    <input type="month" id="reportMonth" required>
                </div>
            </div>

            <div class="upload-grid">
                <div class="upload-box" id="carrierUpload">
                    <h3>Carrier File</h3>
                    <p>My Access, Aflac, etc.</p>
                    <p class="file-name" id="carrierFileName"></p>
                    <input type="file" id="carrierFile" accept=".xlsx,.xls">
                </div>
                <div class="upload-box" id="payrollUpload">
                    <h3>Payroll File</h3>
                    <p>Paycom, ADP, etc.</p>
                    <p class="file-name" id="payrollFileName"></p>
                    <input type="file" id="payrollFile" accept=".xlsx,.xls">
                </div>
            </div>

            <div class="mapping-section" id="mappingSection">
                <h3>Column Mapping</h3>
                <div class="mapping-grid">
                    <div class="mapping-group">
                        <h4>Carrier Columns</h4>
                        <div class="mapping-row">
                            <label>Last Name</label>
                            <select id="carrierLastName"></select>
                        </div>
                        <div class="mapping-row">
                            <label>First Name</label>
                            <select id="carrierFirstName"></select>
                        </div>
                        <div class="mapping-row">
                            <label>Premium</label>
                            <select id="carrierPremium"></select>
                        </div>
                    </div>
                    <div class="mapping-group">
                        <h4>Payroll Columns</h4>
                        <div class="mapping-row">
                            <label>Last Name</label>
                            <select id="payrollLastName"></select>
                        </div>
                        <div class="mapping-row">
                            <label>First Name</label>
                            <select id="payrollFirstName"></select>
                        </div>
                        <div class="mapping-row">
                            <label>Premium</label>
                            <select id="payrollPremium"></select>
                        </div>
                    </div>
                </div>
            </div>

            <div class="actions">
                <button class="btn btn-primary" id="analyzeBtn" disabled>Analyze Files</button>
            </div>
        </div>

        <!-- Phase 1 Results: Name Review -->
        <div class="card hidden" id="nameReviewCard">
            <h2>Phase 1: Name Matching</h2>

            <div class="summary-grid">
                <div class="summary-item success">
                    <div class="value" id="exactMatchCount">0</div>
                    <div class="label">Exact Matches</div>
                </div>
                <div class="summary-item success">
                    <div class="value" id="learnedMatchCount">0</div>
                    <div class="label">Learned Matches</div>
                </div>
                <div class="summary-item warning">
                    <div class="value" id="fuzzyMatchCount">0</div>
                    <div class="label">Need Review</div>
                </div>
                <div class="summary-item">
                    <div class="value" id="unmatchedCarrierCount">0</div>
                    <div class="label">Carrier Only</div>
                </div>
                <div class="summary-item">
                    <div class="value" id="unmatchedPayrollCount">0</div>
                    <div class="label">Payroll Only</div>
                </div>
            </div>

            <div class="review-section" id="fuzzyReviewSection">
                <h3>Review Fuzzy Name Matches</h3>
                <p class="description">These names are similar but not exact. Approved matches will be remembered for future runs.</p>

                <div class="bulk-actions">
                    <span id="nameProgress">0 of 0 reviewed</span>
                    <div>
                        <button class="btn btn-secondary" id="rejectAllNamesBtn">Reject All</button>
                        <button class="btn btn-success" id="approveAllNamesBtn">Approve All</button>
                    </div>
                </div>

                <div id="fuzzyList"></div>
            </div>

            <div class="actions">
                <button class="btn btn-primary" id="submitNamesBtn">Generate Report</button>
            </div>
        </div>

        
        <!-- Download Section -->
        <div class="card download-section" id="downloadSection">
            <h3>Report Ready!</h3>
            <p id="downloadFileName"></p>
            <a href="#" class="btn btn-success" id="downloadBtn" download>Download Excel Report</a>
        </div>
    </main>

    <script>
        // Config
        const API_URL = 'https://mbh.comp.edw4rds.com';
        const SUPABASE_URL = 'https://exzeayeoosiabwhgyquq.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImV4emVheWVvb3NpYWJ3aGd5cXVxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTM5NzQ3MDksImV4cCI6MjA2OTU1MDcwOX0.FPufOFFPsKEk7ZSWL-JgKXACbq7KgEQmNaAnYeyyXgk';

        // State
        let supabase;
        let accessToken = null;
        let carrierFile = null;
        let payrollFile = null;
        let sessionId = null;
        let fuzzyMatches = [];
        let nameDecisions = [];
        let groupName = '';
        let reportMonth = '';
        
        // Initialize
        async function init() {
            supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

            const { data: { session } } = await supabase.auth.getSession();
            if (!session) {
                window.location.href = 'index.html';
                return;
            }

            accessToken = session.access_token;
            document.getElementById('userEmail').textContent = session.user.email;

            // Set default month to current month
            const now = new Date();
            document.getElementById('reportMonth').value = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;

            setupEventListeners();
        }

        function setupEventListeners() {
            // Group and month inputs
            document.getElementById('groupName').addEventListener('input', checkCanAnalyze);
            document.getElementById('reportMonth').addEventListener('change', checkCanAnalyze);

            // File uploads
            document.getElementById('carrierUpload').addEventListener('click', () => document.getElementById('carrierFile').click());
            document.getElementById('payrollUpload').addEventListener('click', () => document.getElementById('payrollFile').click());
            document.getElementById('carrierFile').addEventListener('change', (e) => handleFileSelect(e, 'carrier'));
            document.getElementById('payrollFile').addEventListener('change', (e) => handleFileSelect(e, 'payroll'));

            // Buttons
            document.getElementById('analyzeBtn').addEventListener('click', analyzeFiles);
            document.getElementById('approveAllNamesBtn').addEventListener('click', () => bulkNameDecision(true));
            document.getElementById('rejectAllNamesBtn').addEventListener('click', () => bulkNameDecision(false));
            document.getElementById('submitNamesBtn').addEventListener('click', submitNameDecisions);
        }

        function handleFileSelect(e, type) {
            const file = e.target.files[0];
            if (!file) return;

            if (type === 'carrier') {
                carrierFile = file;
                document.getElementById('carrierUpload').classList.add('has-file');
                document.getElementById('carrierFileName').textContent = file.name;
            } else {
                payrollFile = file;
                document.getElementById('payrollUpload').classList.add('has-file');
                document.getElementById('payrollFileName').textContent = file.name;
            }

            checkCanAnalyze();
            if (carrierFile && payrollFile) {
                document.getElementById('mappingSection').classList.add('visible');
            }
        }

        function checkCanAnalyze() {
            const hasGroup = document.getElementById('groupName').value.trim().length > 0;
            const hasMonth = document.getElementById('reportMonth').value.length > 0;
            document.getElementById('analyzeBtn').disabled = !(carrierFile && payrollFile && hasGroup && hasMonth);
        }

        function populateDropdowns(carrierHeaders, payrollHeaders) {
            const carrierSelects = ['carrierLastName', 'carrierFirstName', 'carrierPremium'];
            const payrollSelects = ['payrollLastName', 'payrollFirstName', 'payrollPremium'];

            const carrierDefaults = {
                carrierLastName: ['LAST', 'Last Name', 'LastName'],
                carrierFirstName: ['FIRST', 'First Name', 'FirstName'],
                carrierPremium: ['Monthly', 'Premium', 'Amount']
            };

            const payrollDefaults = {
                payrollLastName: ['Last', 'Last Name', 'LAST'],
                payrollFirstName: ['First', 'First Name', 'FIRST'],
                payrollPremium: ['Monthly Premium', 'Premium', 'Deduction']
            };

            carrierSelects.forEach(id => {
                const select = document.getElementById(id);
                select.innerHTML = carrierHeaders.map(h =>
                    `<option value="${h}" ${carrierDefaults[id]?.some(d => h.toLowerCase().includes(d.toLowerCase())) ? 'selected' : ''}>${h}</option>`
                ).join('');
            });

            payrollSelects.forEach(id => {
                const select = document.getElementById(id);
                select.innerHTML = payrollHeaders.map(h =>
                    `<option value="${h}" ${payrollDefaults[id]?.some(d => h.toLowerCase().includes(d.toLowerCase())) ? 'selected' : ''}>${h}</option>`
                ).join('');
            });
        }

        function showStatus(message, type = 'loading') {
            const el = document.getElementById('statusMessage');
            el.textContent = message;
            el.className = `status-message visible ${type}`;
        }

        function hideStatus() {
            document.getElementById('statusMessage').classList.remove('visible');
        }

        function setPhase(phase) {
            document.getElementById('phase1Step').className = 'phase-step' + (phase >= 1 ? (phase > 1 ? ' completed' : ' active') : '');
            document.getElementById('phase2Step').className = 'phase-step' + (phase >= 2 ? ' active' : '');
        }

        async function analyzeFiles() {
            if (!carrierFile || !payrollFile) return;

            groupName = document.getElementById('groupName').value.trim();
            reportMonth = document.getElementById('reportMonth').value;

            if (!groupName || !reportMonth) {
                showStatus('Please enter Group Name and Report Month', 'error');
                return;
            }

            showStatus('Analyzing files...', 'loading');

            const formData = new FormData();
            formData.append('carrierFile', carrierFile);
            formData.append('payrollFile', payrollFile);

            const settings = {
                groupName,
                reportMonth,
                carrierLastName: document.getElementById('carrierLastName').value || 'LAST',
                carrierFirstName: document.getElementById('carrierFirstName').value || 'FIRST',
                carrierPremium: document.getElementById('carrierPremium').value || 'Monthly',
                payrollLastName: document.getElementById('payrollLastName').value || 'Last',
                payrollFirstName: document.getElementById('payrollFirstName').value || 'First',
                payrollPremium: document.getElementById('payrollPremium').value || 'Monthly Premium',
                premiumTolerance: 0.02,
                nameMatchThreshold: 80
            };
            formData.append('settings', JSON.stringify(settings));

            try {
                const response = await fetch(`${API_URL}/api/discrepancy/analyze`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${accessToken}` },
                    body: formData
                });

                const data = await response.json();
                if (!response.ok) throw new Error(data.error || 'Analysis failed');

                sessionId = data.sessionId;
                fuzzyMatches = data.fuzzyMatches || [];
                nameDecisions = fuzzyMatches.map(() => null);

                // Populate dropdowns with actual headers
                if (data.carrierHeaders && data.payrollHeaders) {
                    populateDropdowns(data.carrierHeaders, data.payrollHeaders);
                }

                // Show Phase 1 results
                showNameReview(data);
                hideStatus();

            } catch (error) {
                showStatus(`Error: ${error.message}`, 'error');
            }
        }

        function showNameReview(data) {
            document.getElementById('uploadCard').classList.add('hidden');
            document.getElementById('nameReviewCard').classList.remove('hidden');
            setPhase(1);

            document.getElementById('exactMatchCount').textContent = data.exactMatches;
            document.getElementById('learnedMatchCount').textContent = data.learnedMatches;
            document.getElementById('fuzzyMatchCount').textContent = fuzzyMatches.length;
            document.getElementById('unmatchedCarrierCount').textContent = data.unmatchedCarrier;
            document.getElementById('unmatchedPayrollCount').textContent = data.unmatchedPayroll;

            if (fuzzyMatches.length > 0) {
                document.getElementById('fuzzyReviewSection').classList.add('visible');
                renderFuzzyList();
            } else {
                document.getElementById('fuzzyReviewSection').classList.remove('visible');
            }

            updateNameProgress();
        }

        function renderFuzzyList() {
            const list = document.getElementById('fuzzyList');
            list.innerHTML = fuzzyMatches.map((match, i) => `
                <div class="review-item" id="name-${i}">
                    <div class="review-info">
                        <div class="review-names">
                            <span>${match.carrierName}</span>
                            <span class="arrow">â†’</span>
                            <span>${match.payrollName}</span>
                        </div>
                        <div class="review-details">
                            Similarity: <span class="review-score">${match.similarityScore}%</span> |
                            Carrier: $${match.carrierPremium.toFixed(2)} |
                            Payroll: $${match.payrollPremium.toFixed(2)}
                        </div>
                    </div>
                    <div class="review-actions">
                        <button class="approve" onclick="decideNameMatch(${i}, true)">Approve</button>
                        <button class="reject" onclick="decideNameMatch(${i}, false)">Reject</button>
                    </div>
                </div>
            `).join('');
        }

        function decideNameMatch(index, approved) {
            nameDecisions[index] = approved;
            const el = document.getElementById(`name-${index}`);
            el.classList.remove('approved', 'rejected');
            el.classList.add(approved ? 'approved' : 'rejected');
            updateNameProgress();
        }

        function bulkNameDecision(approved) {
            nameDecisions = nameDecisions.map(() => approved);
            fuzzyMatches.forEach((_, i) => {
                const el = document.getElementById(`name-${i}`);
                el.classList.remove('approved', 'rejected');
                el.classList.add(approved ? 'approved' : 'rejected');
            });
            updateNameProgress();
        }

        function updateNameProgress() {
            const reviewed = nameDecisions.filter(d => d !== null).length;
            document.getElementById('nameProgress').textContent = `${reviewed} of ${nameDecisions.length} reviewed`;
        }

        async function submitNameDecisions() {
            showStatus('Generating report...', 'loading');

            const decisions = nameDecisions.map((approved, index) => ({ index, approved: approved ?? false }));

            try {
                const response = await fetch(`${API_URL}/api/discrepancy/submit-names`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${accessToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ sessionId, decisions, generateReport: true })
                });

                const data = await response.json();
                if (!response.ok) throw new Error(data.error || 'Processing failed');

                showDownload(data.fileId, data.fileName);
                hideStatus();

            } catch (error) {
                showStatus(`Error: ${error.message}`, 'error');
            }
        }

        function showDownload(fileId, fileName) {
            document.getElementById('nameReviewCard').classList.add('hidden');
            document.getElementById('downloadSection').classList.add('visible');
            document.getElementById('downloadFileName').textContent = fileName;
            setPhase(2);

            const downloadBtn = document.getElementById('downloadBtn');
            downloadBtn.href = `${API_URL}/api/discrepancy/download/${fileId}?token=${accessToken}`;
            downloadBtn.download = fileName;
        }

        init();
    </script>
</body>
</html>
